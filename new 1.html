<html>
<head>
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="wrapper">
        <div class="shake-btn" style="border: 1px solid black; width: 100px; cursor: pointer">ClickToShake</div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
            $(document).ready(function() {
                
                // GLOBAL
                const CARD_WITH = 132 + 2; //2px - border
                const HF_CARD_WITH = CARD_WITH/2;
                const CARD_HEIGHT = 182;
                const HF_CARD_HEIGHT = CARD_HEIGHT/2;
                const CRD_COND = {FACE_UP: 0, FACE_DOWN: 1, FULL_TURN: 3};
                const ANIMATE_DIR = {LEFT: 0, UP: 1, RIGHT: 2};
                
                var InHandArr = [];
                var onTableArr = [];
                var CurZIndex = 0;
                
                /*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
                function animateCardSort(cardArr){}; //--- need definition ---
                jQuery.fn.animateMoveCardToPlayer = function(direction) { // --- need definition ---
                    switch(direction)
                    {
                        case ANIMATE_DIR.LEFT:
                            break;
                        case ANIMATE_DIR.UP:
                            break;
                        case ANIMATE_DIR.RIGHT:
                            break;
                        default:
                            throw {
                                message: 'animateToPlayer: undefined animation direction',
                                code: 100
                            };
                    }
                };
                /*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
                
                function getDegreeElement(element){

                    var valueStyle = $(element).css('transform');
                    if(valueStyle == 'none') 
                        return 0;

                    //console.log(valueStyle);
                    var values = valueStyle.split('(')[1];
                    values = values.split(')')[0];
                    values = values.split(',');

                    var cos = values[0];
                    var sin = values[1];

                    var degree = Math.round(Math.asin(sin) * (180/Math.PI));
                    if(cos<0){
                        addDegree = 90 - Math.round(Math.asin(sin) * (180/Math.PI));
                        degree = 90 + addDegree;
                    }
                    if(degree < 0){
                        degree = 360 + degree;
                    }
                    return degree;
                }
                
                function resetPos(cardArr) {
                    var tArr = [];
                    for(var i = 0; i < cardArr.length; i++) {
                        tArr.push({
                            front: getDegreeElement($(cardArr[i]).children('.crd-front')), 
                            back: getDegreeElement($(cardArr[i]).children('.crd-back'))
                        });
                    }
                    for(var i = 0; i < cardArr.length; i++) {
                        //$(cardArr[i]).css({transform : 'rotate(0deg)'});
                        //$(cardArr[i]).css({transition: 'none'});
                        $(cardArr[i]).children('.crd-front').css({transform: 'rotate('+tArr[i].front+'deg) rotateY(0)'});
                        $(cardArr[i]).children('.crd-back').css({transform: 'rotate('+tArr[i].back+'deg) rotateY(-180deg)'});
                        $(cardArr[i]).children('.crd-front').css({transition: 'none'});
                        $(cardArr[i]).children('.crd-back').css({transition: 'none'});
                    } 
                }
                
                function animateDeckShake(cardArr){
                    resetPos(cardArr);
                    var PropArr = [];
                    for(var i = 0; i < cardArr.length; i++) {
                        PropArr.push({left: $(cardArr[i]).css('left'), top: $(cardArr[i]).css('top')});
                    }
                    for(var i = 3; i; i--) {
                        for(var j = 0; j < cardArr.length; j++) {
                            var offsetX = Math.floor((Math.random() * 100) - 50);
                            var offsetY = Math.floor((Math.random() * 100) - 50);
                            $(cardArr[j]).flip(CRD_COND.FULL_TURN, false);
                            $(cardArr[j]).animate({left: '-=' +offsetX+'px', top: '-=' +offsetY+'px'}, 300, function(){});
                        }
                    }
                    for(var i = 0; i < cardArr.length; i++) {
                        $(cardArr[i]).animate({left : PropArr[i].left, top : PropArr[i].top}, "500", function(){});
                    }
                    setTimeout(resetPos, 1200, cardArr);
                    
                };
                
                function lockAllCard(){
                    $(".crd-container").attr('data-locked', 'true');
                };              
                function unlockAllCard(){
                    $(".crd-container").attr('data-locked', 'false');
                };
                
                jQuery.fn.lock = function(selector) {
                    $(selector).attr('data-locked', 'true');
                }
                jQuery.fn.unlock = function(selector) {
                    $(selector).attr('data-locked', 'false');
                }
                jQuery.fn.isLocked = function() {
                    if($(this).attr('data-locked') == 'true')
                        return true;  
                    
                    return false;
                };              
                jQuery.fn.setCard = function(cardId) {
                    $(this).css({'background-image' : 'url(img/' + cardId + '.svg)'});
                };            
                jQuery.fn.flip = function(crdCond, exactly = true) {
                    var valFrontSide = "";
                    var valBackSide = "";
                    var degFrontSide = "";
                    var degBackSide = "";
                    var transformVal = '0';
                    
                    if(crdCond == CRD_COND.FACE_UP){
                        degFrontSide = -180;
                        degBackSide = 0;
                        $(this).children('.crd-back').css({transition : 'transform .5s ease-out'});
                        $(this).children('.crd-front').css({transition : 'transform .5s ease-out'});
                    }
                    else if(crdCond == CRD_COND.FACE_DOWN) {
                        //alert("@");
                        degFrontSide = 0;
                        degBackSide = -180;
                        $(this).children('.crd-back').css({transition : 'transform .5s ease-out'}); 
                        $(this).children('.crd-front').css({transition : 'transform .5s ease-out'}); 
                    }
                    else if(crdCond == CRD_COND.FULL_TURN) {
                        //$(this).css({transition : 'transform 1.5s ease-out'});
                        //$(this).css({transform : 'rotate(360deg)'});
                        $(this).children('.crd-back').css({transition : 'transform 1.5s ease-out'});
                        $(this).children('.crd-front').css({transition : 'transform 1.5s ease-out'});
                        degFrontSide = 360;
                        degBackSide = 180;
                    }
                    else {
                        throw {
                            message: "flip: undefined card condition",
                            code: 100
                        };
                    }
                    
                    if(!exactly) {
                        var rotateDegr = Math.floor((Math.random() * 10) - 5); //range -5 ... 5
                        valFrontSide = 'rotate('+ rotateDegr +'deg) rotateY('+ degFrontSide +'deg)';
                        valBackSide = 'rotate('+ rotateDegr +'deg) rotateY('+ degBackSide +'deg)';
                    }
                    else {
                        valFrontSide = 'rotate(0deg) rotateY('+ degFrontSide +'deg)';
                        valBackSide = 'rotate(0deg) rotateY('+ degBackSide +'deg)';
                    }

                    $(this).children('.crd-front').css({transform : valFrontSide});                    
                    $(this).children('.crd-back').css({transform : valBackSide});
                    
                    return $(this);
                };
                
                // INIT
                var w = $(document).width();
                //alert(w);
                var w2 = parseInt(w);
                w2 /= 2;
                w2 -= CARD_WITH;
                var wCenter = w2;

                var h = $(document).height();
                //alert(h);
                var h2 = parseInt(h);
                h = h2 - CARD_HEIGHT - 10;
                h2 /= 2;
                h2 -= HF_CARD_HEIGHT;
               
                // initDeck
                var d = $(".wrapper");
                for(var i = 0; i < 36; i++) {
                    d.append('<div class="crd-container" id='+ parseInt(i+1) +'><div class="crd-front">' + i + '</div><div class="crd-back">'+ i +'</div></div>');
                }
                
                var tArr = d.children(".crd-container");
                for(var i = 0; i < tArr.length; i++){
                    $(tArr[i]).flip(CRD_COND.FACE_DOWN, false);
                    $(tArr[i]).children('.crd-back').setCard(i+1);
                }
                animateDeckShake(tArr);
                // END_INIT
                // END_GLOBAL
                
                
                // onResize() // still worked bad
                $(window).resize(function(){ 
                    w = $(document).width();
                    //alert(w);
                    w2 = parseInt(w);
                    w2 /= 2;
                    w2 -= CARD_WITH;
                    wCenter = w2;
                    h = $(document).height();
                    //alert(h);
                    h2 = parseInt(h);
                    h = h2 - CARD_HEIGHT - 10;
                    h2 /= 2;
                    h2 -= HF_CARD_HEIGHT;
                    var t = w2 - (HF_CARD_WITH * (InHandArr.length-1));
                    if(InHandArr.length > 0) {
                        for(var i = 0; i < InHandArr.length; i++){
                            $(InHandArr[i]).css({left: t + 'px'});
                            $(InHandArr[i]).css({top: h + 'px'});
                            t += CARD_WITH;
                        }
                        w2 = t - CARD_WITH;
                    }
                }); 
                
          
                $('.shake-btn').click(function(){
                    animateDeckShake($('.wrapper').children('.crd-container'));
                });
                
                // onCardClick(InHandArr:array, OnTable:array)
                $('.crd-container').click(function() {
                    
                    if ($(this).isLocked()) {
                        return;
                    };                    
                    lockAllCard();
                    
                    var moveToHand = true;
                    var posInHand = 0;
                    
                    for(var i = 0; i < InHandArr.length; i++) {
                        if(InHandArr[i] === this) {
                            moveToHand = false;
                            posInHand = i;
                            break;
                        }
                    }
                    if(moveToHand) { // move to player
                         $(this).css({'z-index' : CurZIndex++ });
                        InHandArr.push(this);
                        w2 += HF_CARD_WITH;
                        $(this).children('.crd-front').css({'box-shadow': '4px 4px 5px rgba(0,0,0,.5)'});
                        $(this).flip(CRD_COND.FACE_UP);
                        $(this).animate({left: w2 + 'px', top: h + 'px'}, 'slow', function() { 
                                            unlockAllCard();
                                        });
                        if(InHandArr.length > 0) {
                            for(var i = 0; i < InHandArr.length-1; i++){
                                $(InHandArr[i]).animate({left: '-=' + HF_CARD_WITH + 'px'}, 'medium');
                            }
                        }
                    } 
                    else {  // move to table     
                        w2 -= HF_CARD_WITH;
                        $(this).css({'z-index' : CurZIndex++ });
                        
                        $(this).animate({top: h-30 + 'px'}, 'fast', function() {
                                            $(this).flip(CRD_COND.FACE_UP, false);
                                            $(this).animate({left: wCenter + 'px', top: h2 + 'px'}, 'slow', function() {
                                                unlockAllCard();
                                            });
                                        });
                        
                        if(InHandArr.length > 0) {
                            for(var i = 0; i < InHandArr.length; i++){
                                if(i <= posInHand) {
                                    $(InHandArr[i]).animate({"left": '+=' + HF_CARD_WITH + 'px'}, 'slow'/*, function(){}*/);
                                }
                                else {

                                    $(InHandArr[i]).animate({"left": '-=' + HF_CARD_WITH + 'px'}, 'slow'/*, function(){}*/);
                                }
                            }
                        }
                        InHandArr.splice(posInHand, 1);
                        posInHand = 0;
                    }
                });
            });
    </script>
</body>
</html>